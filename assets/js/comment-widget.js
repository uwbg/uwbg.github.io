!function(){"use strict";const e="https://user.ucbg.online/comment-api";function getCookie(e){const t=document.cookie.split("; ");for(let n of t){const[t,o]=n.split("=");if(t===e)return decodeURIComponent(o)}return null}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}class t{constructor(e,t){this.container=e,this.gameName=t,this.currentPage=1,this.authToken=null,this.currentUser=null,this.selectedRating=0,this.isLoading=!1,this.cooldownUntil=0,this.init()}async init(){this.render(),await this.verifySession(),await this.loadComments()}render(){this.container.innerHTML='\n                <div class="comment-widget" style="\n                    font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n                    background: #121317;\n                    border-radius: 12px;\n                    box-shadow: 0 4px 16px rgba(0,0,0,0.4);\n                    padding: 20px;\n                    margin: 20px 0;\n                ">\n                    <div class="cw-header" style="margin-bottom: 20px;">\n                        <h3 style="margin: 0 0 10px 0; color: #e5e7eb; font-size: 20px;">\n                            üí¨ Comments\n                        </h3>\n                        <div class="cw-stats" style="\n                            display: flex;\n                            gap: 20px;\n                            padding: 12px;\n                            background: #1a1d24;\n                            border-radius: 8px;\n                            font-size: 14px;\n                            border: 1px solid #2a2d35;\n                        ">\n                            <div>\n                                <span style="color: #9ca3af;">Rating:</span>\n                                <strong class="cw-avg-rating" style="color: #ffc107; margin-left: 5px;">-</strong>\n                            </div>\n                            <div>\n                                <span style="color: #9ca3af;">Total:</span>\n                                <strong class="cw-total" style="color: #4a9eff; margin-left: 5px;">0</strong>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class="cw-auth-status" style="\n                        padding: 12px;\n                        border-radius: 8px;\n                        margin-bottom: 15px;\n                        font-size: 14px;\n                        display: none;\n                    "></div>\n\n                    <div class="cw-form" style="\n                        padding: 15px;\n                        background: #1a1d24;\n                        border-radius: 8px;\n                        margin-bottom: 20px;\n                        display: none;\n                        border: 1px solid #2a2d35;\n                    ">\n                        <div style="margin-bottom: 12px;">\n                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #e5e7eb; font-size: 14px;">\n                                Your Rating\n                            </label>\n                            <div class="cw-rating-input" style="display: flex; gap: 5px; font-size: 28px;">\n                                <span data-rating="1" style="cursor: pointer; color: #3a3d45; transition: color 0.2s;">‚òÖ</span>\n                                <span data-rating="2" style="cursor: pointer; color: #3a3d45; transition: color 0.2s;">‚òÖ</span>\n                                <span data-rating="3" style="cursor: pointer; color: #3a3d45; transition: color 0.2s;">‚òÖ</span>\n                                <span data-rating="4" style="cursor: pointer; color: #3a3d45; transition: color 0.2s;">‚òÖ</span>\n                                <span data-rating="5" style="cursor: pointer; color: #3a3d45; transition: color 0.2s;">‚òÖ</span>\n                            </div>\n                        </div>\n                        <div style="margin-bottom: 12px;">\n                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #e5e7eb; font-size: 14px;">\n                                Your Comment\n                            </label>\n                            <textarea class="cw-comment-input" maxlength="500" placeholder="Share your thoughts..." style="\n                                width: 100%;\n                                padding: 10px;\n                                border: 1px solid #2a2d35;\n                                border-radius: 8px;\n                                font-family: inherit;\n                                font-size: 14px;\n                                resize: vertical;\n                                min-height: 80px;\n                                box-sizing: border-box;\n                                background: #0f1115;\n                                color: #e5e7eb;\n                            "></textarea>\n                            <div style="text-align: right; font-size: 12px; color: #6b7280; margin-top: 3px;">\n                                <span class="cw-char-count">0</span>/500\n                            </div>\n                        </div>\n                        <button class="cw-submit-btn" style="\n                            width: 100%;\n                            padding: 10px;\n                            border: none;\n                            border-radius: 8px;\n                            background: #4a9eff;\n                            color: white;\n                            font-size: 14px;\n                            font-weight: 500;\n                            cursor: pointer;\n                            transition: all 0.2s;\n                        " onmouseover="this.style.background=\'#3a8eef\'" onmouseout="this.style.background=\'#4a9eff\'">Post Comment</button>\n                        <div class="cw-message" style="\n                            margin-top: 10px;\n                            padding: 10px;\n                            border-radius: 8px;\n                            font-size: 13px;\n                            display: none;\n                        "></div>\n                    </div>\n\n                    <div class="cw-comments-list" style="\n                        display: flex;\n                        flex-direction: column;\n                        gap: 12px;\n                    ">\n                        <div style="text-align: center; padding: 20px; color: #9ca3af;">\n                            Loading comments...\n                        </div>\n                    </div>\n\n                    <div class="cw-pagination" style="\n                        display: flex;\n                        justify-content: center;\n                        align-items: center;\n                        gap: 10px;\n                        margin-top: 20px;\n                        display: none;\n                    ">\n                        <button class="cw-prev-btn" style="\n                            padding: 8px 16px;\n                            border: 1px solid #2a2d35;\n                            border-radius: 6px;\n                            background: #1a1d24;\n                            color: #e5e7eb;\n                            font-size: 14px;\n                            cursor: pointer;\n                            transition: all 0.2s;\n                        " onmouseover="this.style.background=\'#2a2d35\'" onmouseout="this.style.background=\'#1a1d24\'">‚Üê Previous</button>\n                        <span class="cw-page-info" style="color: #9ca3af; font-size: 14px;">Page 1</span>\n                        <button class="cw-next-btn" style="\n                            padding: 8px 16px;\n                            border: 1px solid #2a2d35;\n                            border-radius: 6px;\n                            background: #1a1d24;\n                            color: #e5e7eb;\n                            font-size: 14px;\n                            cursor: pointer;\n                            transition: all 0.2s;\n                        " onmouseover="this.style.background=\'#2a2d35\'" onmouseout="this.style.background=\'#1a1d24\'">Next ‚Üí</button>\n                    </div>\n                </div>\n            ',this.attachEventListeners()}attachEventListeners(){this.container.querySelectorAll(".cw-rating-input span").forEach(e=>{e.addEventListener("click",()=>{this.selectedRating=parseInt(e.dataset.rating),this.updateRatingDisplay()})});const e=this.container.querySelector(".cw-comment-input"),t=this.container.querySelector(".cw-char-count");e.addEventListener("input",()=>{t.textContent=e.value.length});this.container.querySelector(".cw-submit-btn").addEventListener("click",()=>this.submitComment());const n=this.container.querySelector(".cw-prev-btn"),o=this.container.querySelector(".cw-next-btn");n.addEventListener("click",()=>this.goToPage(this.currentPage-1)),o.addEventListener("click",()=>this.goToPage(this.currentPage+1))}updateRatingDisplay(){this.container.querySelectorAll(".cw-rating-input span").forEach((e,t)=>{t<this.selectedRating?e.style.color="#ffc107":e.style.color="#3a3d45"})}async verifySession(){this.authToken=getCookie("chatAuthToken");const t=getCookie("chatNick"),n=this.container.querySelector(".cw-auth-status"),o=this.container.querySelector(".cw-form");if(this.authToken)try{const t=await fetch(`${e}/verify-session.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.authToken})}),s=await t.json();if(s.success&&s.valid)return this.currentUser=s.user,n.style.display="block",n.style.background="#1a2e1a",n.style.border="1px solid #2a4d2a",n.style.color="#4ade80",n.textContent=`‚úì Logged in as ${s.user.name}`,void(o.style.display="block");this.authToken=null}catch(e){console.error("Session verify error:",e),this.authToken=null}if(t&&""!==t.trim())return this.currentUser={name:t,isGuest:!0},n.style.display="block",n.style.background="#1a1d24",n.style.border="1px solid #2a2d35",n.style.color="#9ca3af",n.innerHTML=`üë§ Guest: ${escapeHtml(t)} | <button onclick="window.openUserAuthModal()" style="\n          background: #4a9eff;\n          color: white;\n          border: none;\n          padding: 4px 12px;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 13px;\n          margin-left: 8px;\n          transition: background 0.2s;\n        " onmouseover="this.style.background='#3a8eef'" onmouseout="this.style.background='#4a9eff'">Login / Register</button>`,void(o.style.display="block");n.style.display="block",n.style.background="#2a2210",n.style.border="1px solid #3d3520",n.style.color="#fbbf24",n.innerHTML='‚ö†Ô∏è Please login to post comments <button onclick="window.openUserAuthModal()" style="\n        background: #4a9eff;\n        color: white;\n        border: none;\n        padding: 6px 16px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 14px;\n        margin-left: 10px;\n        transition: background 0.2s;\n      " onmouseover="this.style.background=\'#3a8eef\'" onmouseout="this.style.background=\'#4a9eff\'">Login / Register</button>',o.style.display="none"}async loadComments(){if(this.isLoading)return;this.isLoading=!0;const t=this.container.querySelector(".cw-comments-list");t.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';try{const n=await fetch(`${e}/get-comments.php?game_name=${encodeURIComponent(this.gameName)}&page=${this.currentPage}&per_page=10`),o=await n.json();if(o.success){const e=this.container.querySelector(".cw-avg-rating"),n=this.container.querySelector(".cw-total");o.stats.average_rating>0?e.textContent="‚òÖ".repeat(Math.round(o.stats.average_rating))+` (${o.stats.average_rating})`:e.textContent="-",n.textContent=o.stats.total_comments,0===o.comments.length?t.innerHTML='<div style="text-align: center; padding: 20px; color: #9ca3af;">No comments yet. Be the first!</div>':t.innerHTML=o.comments.map(e=>this.renderComment(e)).join(""),this.updatePagination(o.pagination)}else t.innerHTML='<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load comments</div>'}catch(e){console.error("Load comments error:",e),t.innerHTML='<div style="text-align: center; padding: 20px; color: #ef4444;">Network error</div>'}finally{this.isLoading=!1}}renderComment(e){let t=!1;return this.currentUser&&!this.currentUser.isGuest&&(t=this.currentUser.userId===e.user_id),`\n                <div class="cw-comment-item" style="\n                    padding: 12px;\n                    border: 1px solid #2a2d35;\n                    border-radius: 8px;\n                    background: #1a1d24;\n                ">\n                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">\n                        <span style="font-weight: 600; color: ${e.is_registered?"#4a9eff":"#9ca3af"}; font-size: 14px;">\n                            ${escapeHtml(e.user_name)}\n                            ${e.is_registered?' <span style="color: #4a9eff;">‚úì</span>':' <span style="background: #2a2d35; color: #9ca3af; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 500;">GUEST</span>'}\n                        </span>\n                        <span style="color: #ffc107; font-size: 16px;">\n                            ${"‚òÖ".repeat(e.rating)}\n                        </span>\n                    </div>\n                    <div style="color: #d1d5db; line-height: 1.5; margin-bottom: 8px; font-size: 14px;">\n                        ${escapeHtml(e.comment)}\n                    </div>\n                    <div style="display: flex; justify-content: space-between; align-items: center;">\n                        <span style="font-size: 12px; color: #6b7280;">\n                            ${function formatDate(e){const t=new Date(e),n=new Date-t,o=Math.floor(n/6e4),s=Math.floor(n/36e5),i=Math.floor(n/864e5);return o<1?"Just now":o<60?`${o} min${o>1?"s":""} ago`:s<24?`${s} hour${s>1?"s":""} ago`:i<7?`${i} day${i>1?"s":""} ago`:t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}(e.created_at)}\n                        </span>\n                        ${t?`\n                            <button onclick="window.commentWidgets['${this.gameName}'].deleteComment(${e.id})" style="\n                                padding: 4px 8px;\n                                border: none;\n                                border-radius: 4px;\n                                background: #3f1f1f;\n                                color: #ef4444;\n                                font-size: 12px;\n                                cursor: pointer;\n                                transition: background 0.2s;\n                            " onmouseover="this.style.background='#4f2626'" onmouseout="this.style.background='#3f1f1f'">Delete</button>\n                        `:""}\n                    </div>\n                </div>\n            `}updatePagination(e){const t=this.container.querySelector(".cw-pagination"),n=this.container.querySelector(".cw-prev-btn"),o=this.container.querySelector(".cw-next-btn"),s=this.container.querySelector(".cw-page-info");e.total_pages>1?(t.style.display="flex",s.textContent=`Page ${e.current_page} of ${e.total_pages}`,n.disabled=!e.has_prev,o.disabled=!e.has_next,n.style.opacity=e.has_prev?"1":"0.5",o.style.opacity=e.has_next?"1":"0.5",n.style.cursor=e.has_prev?"pointer":"not-allowed",o.style.cursor=e.has_next?"pointer":"not-allowed"):t.style.display="none"}async goToPage(e){this.currentPage=e,await this.loadComments(),this.container.querySelector(".cw-comments-list").scrollIntoView({behavior:"smooth",block:"start"})}showMessage(e,t="success"){const n=this.container.querySelector(".cw-message");n.textContent=e,n.style.display="block","success"===t?(n.style.background="#1a2e1a",n.style.color="#4ade80",n.style.border="1px solid #2a4d2a"):(n.style.background="#2e1a1a",n.style.color="#ef4444",n.style.border="1px solid #4d2a2a"),setTimeout(()=>{n.style.display="none"},4e3)}async submitComment(){if(!this.currentUser)return void this.showMessage("Please login to post comments","error");if(0===this.selectedRating)return void this.showMessage("Please select a rating","error");const t=this.container.querySelector(".cw-comment-input"),n=t.value.trim();if(!n)return void this.showMessage("Please enter a comment","error");const o=Date.now();if(this.cooldownUntil>o){const e=Math.ceil((this.cooldownUntil-o)/1e3);return void this.showMessage(`Please wait ${e} seconds`,"error")}const s=this.container.querySelector(".cw-submit-btn");s.disabled=!0,s.textContent="Posting...";try{const s={game_name:this.gameName,comment:n,rating:this.selectedRating};this.currentUser.isGuest?s.guest_name=this.currentUser.name:s.token=this.authToken;const i=await fetch(`${e}/add-comment.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),a=await i.json();a.success?(this.showMessage("Comment posted successfully!","success"),t.value="",this.selectedRating=0,this.updateRatingDisplay(),this.container.querySelector(".cw-char-count").textContent="0",this.cooldownUntil=o+3e4,this.currentPage=1,await this.loadComments()):this.showMessage(a.error||"Failed to post comment","error")}catch(e){console.error("Submit comment error:",e),this.showMessage("Network error. Please try again.","error")}finally{s.disabled=!1,s.textContent="Post Comment"}}async deleteComment(t){if(confirm("Are you sure you want to delete this comment?"))try{const n={comment_id:t,token:this.authToken},o=await fetch(`${e}/delete-comment.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),s=await o.json();s.success?await this.loadComments():alert(s.error||"Failed to delete comment")}catch(e){console.error("Delete comment error:",e),alert("Network error. Please try again.")}}}function initCommentWidgets(){document.querySelectorAll(".comment[game]").forEach(e=>{const n=e.getAttribute("game");n&&!window.commentWidgets[n]&&(window.commentWidgets[n]=new t(e,n))})}if(window.commentWidgets=window.commentWidgets||{},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initCommentWidgets):initCommentWidgets(),"undefined"!=typeof MutationObserver){new MutationObserver(initCommentWidgets).observe(document.body,{childList:!0,subtree:!0})}}();