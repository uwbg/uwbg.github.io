!function(){"use strict";const e="https://user.ucbg.online/user-api";function getCookie(e){const n=document.cookie.split("; ");for(let t of n){const[n,o]=t.split("=");if(n===e)return decodeURIComponent(o)}return null}function setCookie(e,n,t=365){const o=new Date(Date.now()+864e5*t).toUTCString();document.cookie=`${e}=${encodeURIComponent(n)}; expires=${o}; path=/`}function deleteCookie(e){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`}class n{constructor(e){this.container=e,this.authToken=null,this.currentUser=null,this.currentView="main",this.isOpen=!1,this.init()}async init(){this.render(),await this.checkAuth(),this.setupGlobalTrigger()}setupGlobalTrigger(){window.openUserAuthModal=()=>{this.open()}}open(){this.isOpen=!0;const e=this.container.querySelector(".uw-modal");e&&(e.style.display="flex")}close(){this.isOpen=!1;const e=this.container.querySelector(".uw-modal");e&&(e.style.display="none")}async checkAuth(){if(this.authToken=getCookie("chatAuthToken"),!this.authToken){const e=getCookie("chatNick");return void(e?this.showGuestMode(e):this.showMainView())}try{const n=await fetch(`${e}/verify-session.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.authToken})}),t=await n.json();t.success&&t.valid?(this.currentUser=t.user,this.showLoggedIn()):(this.authToken=null,deleteCookie("chatAuthToken"),this.showMainView())}catch(e){console.error("Session verify error:",e),this.showMainView()}}render(){this.container.innerHTML='\n                \x3c!-- Modal Backdrop --\x3e\n                <div class="uw-modal" style="\n                    display: none;\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    background: rgba(0, 0, 0, 0.7);\n                    backdrop-filter: blur(5px);\n                    z-index: 99999;\n                    justify-content: center;\n                    align-items: center;\n                    animation: uwBackdropFadeIn 0.3s ease-in-out;\n                ">\n                    <div class="uw-widget" style="\n                        width: 400px;\n                        max-width: 90%;\n                        background: #1a1a1a;\n                        border-radius: 12px;\n                        box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n                        padding: 24px;\n                        color: #ffffff;\n                        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n                        animation: uwSlideIn 0.3s ease-in-out;\n                        position: relative;\n                    " onclick="event.stopPropagation()">\n                        <button class="uw-close-btn" style="\n                            position: absolute;\n                            top: 16px;\n                            right: 16px;\n                            background: none;\n                            border: none;\n                            color: #999999;\n                            font-size: 24px;\n                            cursor: pointer;\n                            padding: 0;\n                            width: 32px;\n                            height: 32px;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            border-radius: 50%;\n                            transition: all 0.2s;\n                        " onmouseover="this.style.background=\'#2a2a2a\'; this.style.color=\'#ffffff\';" \n                           onmouseout="this.style.background=\'none\'; this.style.color=\'#999999\';">\n                            √ó\n                        </button>\n                        <div class="uw-content"></div>\n                    </div>\n                </div>\n                <style>\n                    @keyframes uwBackdropFadeIn {\n                        from { opacity: 0; }\n                        to { opacity: 1; }\n                    }\n                    @keyframes uwSlideIn {\n                        from { opacity: 0; transform: scale(0.9) translateY(-20px); }\n                        to { opacity: 1; transform: scale(1) translateY(0); }\n                    }\n                    .uw-widget * { box-sizing: border-box; }\n                    .uw-input {\n                        width: 100%;\n                        padding: 12px;\n                        background: #2a2a2a;\n                        border: 1px solid #444444;\n                        border-radius: 8px;\n                        color: #ffffff;\n                        font-size: 14px;\n                        margin-bottom: 12px;\n                        transition: border-color 0.2s;\n                    }\n                    .uw-input:focus {\n                        outline: none;\n                        border-color: #4CAF50;\n                    }\n                    .uw-input::placeholder {\n                        color: #999999;\n                    }\n                    .uw-btn {\n                        width: 100%;\n                        padding: 12px;\n                        border: none;\n                        border-radius: 8px;\n                        font-size: 14px;\n                        font-weight: 600;\n                        cursor: pointer;\n                        transition: all 0.2s;\n                    }\n                    .uw-btn:hover {\n                        transform: translateY(-2px);\n                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n                    }\n                    .uw-btn:disabled {\n                        opacity: 0.5;\n                        cursor: not-allowed;\n                        transform: none;\n                    }\n                    .uw-btn-primary {\n                        background: #4CAF50;\n                        color: #ffffff;\n                    }\n                    .uw-btn-secondary {\n                        background: #2196F3;\n                        color: #ffffff;\n                    }\n                    .uw-btn-outline {\n                        background: transparent;\n                        border: 1px solid #444444;\n                        color: #ffffff;\n                    }\n                    .uw-btn-danger {\n                        background: #f44336;\n                        color: #ffffff;\n                    }\n                    .uw-divider {\n                        display: flex;\n                        align-items: center;\n                        text-align: center;\n                        margin: 16px 0;\n                        color: #999999;\n                        font-size: 12px;\n                    }\n                    .uw-divider::before,\n                    .uw-divider::after {\n                        content: \'\';\n                        flex: 1;\n                        border-bottom: 1px solid #444444;\n                    }\n                    .uw-divider span {\n                        padding: 0 10px;\n                    }\n                    .uw-error {\n                        background: rgba(244, 67, 54, 0.1);\n                        border: 1px solid #f44336;\n                        color: #f44336;\n                        padding: 10px;\n                        border-radius: 8px;\n                        font-size: 13px;\n                        margin-bottom: 12px;\n                    }\n                    .uw-success {\n                        background: rgba(76, 175, 80, 0.1);\n                        border: 1px solid #4CAF50;\n                        color: #4CAF50;\n                        padding: 10px;\n                        border-radius: 8px;\n                        font-size: 13px;\n                        margin-bottom: 12px;\n                    }\n                    .uw-link {\n                        color: #2196F3;\n                        text-decoration: none;\n                        font-size: 13px;\n                        cursor: pointer;\n                    }\n                    .uw-link:hover {\n                        text-decoration: underline;\n                    }\n                    .uw-back-btn {\n                        background: none;\n                        border: none;\n                        color: #2196F3;\n                        font-size: 14px;\n                        cursor: pointer;\n                        padding: 0;\n                        margin-bottom: 16px;\n                        display: inline-flex;\n                        align-items: center;\n                        gap: 4px;\n                    }\n                    .uw-back-btn:hover {\n                        text-decoration: underline;\n                    }\n                </style>\n            ';const e=this.container.querySelector(".uw-close-btn"),n=this.container.querySelector(".uw-modal");e.addEventListener("click",()=>this.close()),n.addEventListener("click",e=>{e.target===n&&this.close()})}showMainView(){const n=this.container.querySelector(".uw-content");n.innerHTML='\n                <h2 style="margin: 0 0 20px 0; font-size: 20px; display: flex; align-items: center; gap: 8px;">\n                    üë§ User Login\n                </h2>\n                \n                <div style="margin-bottom: 16px;">\n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">\n                        Guest Nickname\n                    </label>\n                    <input type="text" class="uw-input uw-guest-input" placeholder="Enter your nickname..." maxlength="32">\n                    <div class="uw-guest-error" style="display: none; color: #f44336; font-size: 12px; margin-top: 4px;"></div>\n                </div>\n                \n                <button class="uw-btn uw-btn-primary uw-guest-btn" style="margin-bottom: 16px;">\n                    Continue as Guest\n                </button>\n                \n                <div class="uw-divider"><span>or</span></div>\n                \n                <div style="display: flex; gap: 8px;">\n                    <button class="uw-btn uw-btn-secondary uw-login-btn" style="flex: 1;">Login</button>\n                    <button class="uw-btn uw-btn-outline uw-register-btn" style="flex: 1;">Register</button>\n                </div>\n            ';const t=n.querySelector(".uw-guest-input"),o=n.querySelector(".uw-guest-btn"),s=n.querySelector(".uw-guest-error"),i=n.querySelector(".uw-login-btn"),r=n.querySelector(".uw-register-btn");o.addEventListener("click",async()=>{const n=t.value.trim();if(!n)return s.textContent="Please enter a nickname",void(s.style.display="block");o.disabled=!0,o.textContent="Checking...";try{const t=await fetch(`${e}/check-username.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n})}),i=await t.json();i.success&&i.isRegistered?(s.textContent="This name is registered. Please login or choose another.",s.style.display="block",o.disabled=!1,o.textContent="Continue as Guest"):i.success&&i.available?(setCookie("chatNick",n),window.location.reload()):(s.textContent=i.error||"Error checking username",s.style.display="block",o.disabled=!1,o.textContent="Continue as Guest")}catch(e){console.error("Check username error:",e),s.textContent="Network error. Please try again.",s.style.display="block",o.disabled=!1,o.textContent="Continue as Guest"}}),i.addEventListener("click",()=>this.showLoginView()),r.addEventListener("click",()=>this.showRegisterView())}showGuestMode(e){const n=this.container.querySelector(".uw-content");n.innerHTML=`\n                <h2 style="margin: 0 0 12px 0; font-size: 20px; display: flex; align-items: center; gap: 8px;">\n                    üë§ Guest: ${this.escapeHtml(e)}\n                </h2>\n                \n                <p style="color: #999999; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5;">\n                    You're browsing as a guest. Login to save your preferences and access more features.\n                </p>\n                \n                <div style="display: flex; gap: 8px; margin-bottom: 12px;">\n                    <button class="uw-btn uw-btn-secondary uw-login-btn" style="flex: 1;">Login</button>\n                    <button class="uw-btn uw-btn-outline uw-register-btn" style="flex: 1;">Register</button>\n                </div>\n                \n                <button class="uw-btn uw-btn-danger uw-guest-logout-btn">\n                    Logout (Clear Guest)\n                </button>\n            `;const t=n.querySelector(".uw-login-btn"),o=n.querySelector(".uw-register-btn"),s=n.querySelector(".uw-guest-logout-btn");t.addEventListener("click",()=>this.showLoginView()),o.addEventListener("click",()=>this.showRegisterView()),s.addEventListener("click",()=>{deleteCookie("chatNick"),this.showMainView()})}showLoggedIn(){const e=this.container.querySelector(".uw-content");e.innerHTML=`\n                <h2 style="margin: 0 0 8px 0; font-size: 20px; display: flex; align-items: center; gap: 8px;">\n                    ‚úì Welcome, ${this.escapeHtml(this.currentUser.name)}\n                </h2>\n                \n                <p style="color: #999999; font-size: 13px; margin: 0 0 20px 0;">\n                    ${this.escapeHtml(this.currentUser.email)}\n                </p>\n                \n                <button class="uw-btn uw-btn-danger uw-logout-btn">\n                    Logout\n                </button>\n            `;e.querySelector(".uw-logout-btn").addEventListener("click",()=>this.handleLogout())}showLoginView(){const e=this.container.querySelector(".uw-content");e.innerHTML='\n                <button class="uw-back-btn">‚Üê Back</button>\n                \n                <h2 style="margin: 0 0 20px 0; font-size: 20px;">Login</h2>\n                \n                <div class="uw-message" style="display: none;"></div>\n                \n                <form class="uw-login-form">\n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">Email</label>\n                    <input type="email" class="uw-input" name="email" placeholder="your@email.com" required>\n                    \n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">Password</label>\n                    <input type="password" class="uw-input" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">\n                    \n                    <div style="text-align: right; margin-bottom: 16px;">\n                        <a class="uw-link uw-forgot-link">Forgot Password?</a>\n                    </div>\n                    \n                    <button type="submit" class="uw-btn uw-btn-primary">Login</button>\n                </form>\n            ';const n=e.querySelector(".uw-back-btn"),t=e.querySelector(".uw-login-form"),o=e.querySelector(".uw-message"),s=e.querySelector(".uw-forgot-link");n.addEventListener("click",()=>this.showMainView()),s.addEventListener("click",()=>this.showForgotPasswordView()),t.addEventListener("submit",async e=>{e.preventDefault(),await this.handleLogin(t,o)})}showRegisterView(){const e=this.container.querySelector(".uw-content");e.innerHTML='\n                <button class="uw-back-btn">‚Üê Back</button>\n                \n                <h2 style="margin: 0 0 20px 0; font-size: 20px;">Register</h2>\n                \n                <div class="uw-message" style="display: none;"></div>\n                \n                <form class="uw-register-form">\n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">Username</label>\n                    <input type="text" class="uw-input" name="name" placeholder="JohnDoe" required maxlength="32">\n                    \n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">Email</label>\n                    <input type="email" class="uw-input" name="email" placeholder="your@email.com" required>\n                    \n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">Password</label>\n                    <input type="password" class="uw-input" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">\n                    \n                    <button type="submit" class="uw-btn uw-btn-primary">Register</button>\n                </form>\n            ';const n=e.querySelector(".uw-back-btn"),t=e.querySelector(".uw-register-form"),o=e.querySelector(".uw-message");n.addEventListener("click",()=>this.showMainView()),t.addEventListener("submit",async e=>{e.preventDefault(),await this.handleRegister(t,o)})}showForgotPasswordView(){const e=this.container.querySelector(".uw-content");e.innerHTML='\n                <button class="uw-back-btn">‚Üê Back</button>\n                \n                <h2 style="margin: 0 0 12px 0; font-size: 20px;">Forgot Password</h2>\n                \n                <p style="color: #999999; font-size: 13px; margin: 0 0 20px 0; line-height: 1.5;">\n                    Enter your email address and we\'ll send you a link to reset your password.\n                </p>\n                \n                <div class="uw-message" style="display: none;"></div>\n                \n                <form class="uw-forgot-form">\n                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #999999;">Email</label>\n                    <input type="email" class="uw-input" name="email" placeholder="your@email.com" required>\n                    \n                    <button type="submit" class="uw-btn uw-btn-primary">Send Reset Link</button>\n                </form>\n            ';const n=e.querySelector(".uw-back-btn"),t=e.querySelector(".uw-forgot-form"),o=e.querySelector(".uw-message");n.addEventListener("click",()=>this.showLoginView()),t.addEventListener("submit",async e=>{e.preventDefault(),await this.handleForgotPassword(t,o)})}async handleLogin(n,t){const o=n.querySelector('button[type="submit"]'),s=new FormData(n);o.disabled=!0,o.textContent="Logging in...",t.style.display="none";try{const n=await fetch(`${e}/login.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.get("email"),password:s.get("password")})}),i=await n.json();i.success?(setCookie("chatAuthToken",i.token),setCookie("chatNick",i.user.name),this.authToken=i.token,this.currentUser=i.user,window.location.reload()):(t.className="uw-message uw-error",t.textContent=i.error||"Login failed",t.style.display="block",o.disabled=!1,o.textContent="Login")}catch(e){console.error("Login error:",e),t.className="uw-message uw-error",t.textContent="Network error. Please try again.",t.style.display="block",o.disabled=!1,o.textContent="Login"}}async handleRegister(n,t){const o=n.querySelector('button[type="submit"]'),s=new FormData(n);o.disabled=!0,o.textContent="Registering...",t.style.display="none";try{const n=await fetch(`${e}/register.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s.get("name"),email:s.get("email"),password:s.get("password")})}),i=await n.json();i.success?(t.className="uw-message uw-success",t.textContent="Registration successful! Redirecting to login...",t.style.display="block",setTimeout(()=>{this.showLoginView()},2e3)):(t.className="uw-message uw-error",t.textContent=i.error||"Registration failed",t.style.display="block",o.disabled=!1,o.textContent="Register")}catch(e){console.error("Register error:",e),t.className="uw-message uw-error",t.textContent="Network error. Please try again.",t.style.display="block",o.disabled=!1,o.textContent="Register"}}async handleForgotPassword(n,t){const o=n.querySelector('button[type="submit"]'),s=new FormData(n);o.disabled=!0,o.textContent="Sending...",t.style.display="none";try{const i=await fetch(`${e}/forgot-password.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.get("email")})}),r=await i.json();r.success?(t.className="uw-message uw-success",t.textContent=r.message,t.style.display="block",n.reset(),o.disabled=!1,o.textContent="Send Reset Link"):(t.className="uw-message uw-error",t.textContent=r.error||"Failed to send reset link",t.style.display="block",o.disabled=!1,o.textContent="Send Reset Link")}catch(e){console.error("Forgot password error:",e),t.className="uw-message uw-error",t.textContent="Network error. Please try again.",t.style.display="block",o.disabled=!1,o.textContent="Send Reset Link"}}async handleLogout(){try{await fetch(`${e}/logout.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.authToken})}),deleteCookie("chatAuthToken"),deleteCookie("chatNick"),this.authToken=null,this.currentUser=null,this.showMainView()}catch(e){console.error("Logout error:",e)}}escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}}function initUserWidgets(){document.querySelectorAll(".user-login-widget-ucbg-system").forEach(e=>{e.dataset.initialized||(new n(e),e.dataset.initialized="true")})}if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",initUserWidgets):initUserWidgets(),"undefined"!=typeof MutationObserver){new MutationObserver(initUserWidgets).observe(document.body,{childList:!0,subtree:!0})}}();